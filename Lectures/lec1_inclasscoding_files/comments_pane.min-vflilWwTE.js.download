define(["require","exports","tslib","react","external/react-redux","modules/clean/react/css","external/classnames","spectrum_comments/comment","spectrum_comments/comment_editor","spectrum_comments/comment_stream","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/legacy_annotations_bridge","modules/clean/react/comments2/components/onboarding","modules/clean/react/comments2/util","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/mentions_api","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_action_button","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/data/frame_message_listener","modules/clean/react/comments2/components/tooltips","modules/core/browser"],function(e,t,n,o,r,i,a,s,m,c,p,d,l,u,g,h,b,v,f,_,y,T,E,w,C,A){"use strict";function M(e,t){return void 0===t&&(t=1),e===T.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[{page:t,x:0,y:0,width:1,height:1}]}:{type:"image",region:{page:t,x:0,y:0,width:1,height:1}}}function O(e){var t=e.currentPageNumber,r=e.disabledTimeCodeTooltipComponent,i=e.playerCurrentTime,a=void 0===i?0:i,s=e.pendingNumberedAnnotation,c=e.playerIntegrationEnabled,p=e.previewType;if(p===T.PreviewType.Audio){var d=c?void 0:r;return o.default.createElement(m.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:"audio",time:a},tooltipComponent:d}))}if(p===T.PreviewType.Video){var d=c?void 0:r;return o.default.createElement(m.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:"video",time:a},tooltipComponent:d}))}return p===T.PreviewType.SsrDoc||p===T.PreviewType.Image?o.default.createElement(m.NumberedCommentEditor,n.__assign({},e,{defaultAnnotation:M(p,t),pendingAnnotation:s})):o.default.createElement(m.CommentEditor,n.__assign({},e))}Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),r=n.__importStar(r),a=n.__importDefault(a),b=n.__importStar(b),A=n.__importStar(A);var S=function(e){var t=e.children,n=e.markOnboarded,r=e.playerIntegrationEnabled,i=e.previewType,a=r?"target-annotation":"target-mention";return o.default.createElement(m.CoachMarkContainer,{className:a},t,o.default.createElement(l.CoachMark,{markOnboarded:n,playerIntegrationEnabled:r,previewType:i}))},P=(function(e){function t(t){var r=e.call(this,t)||this;r.onCommentStreamRef=function(e){return r.commentStream=e},r.updateMentionsMatches=function(e){r.setState({mentionsMatches:e})},r.onMentionsQueryUpdated=function(e){e?r.mentionsApi.query(e,r.updateMentionsMatches):""===e&&r.updateMentionsMatches(r.mentionsApi.getMatchesWithStarterSuggestions())},r.toggleShowResolved=function(){var e=r.props,t=e.dispatch,n=e.showResolved,o=n?"hide_resolved_threads":"show_resolved_threads";t(h.Actions.toggleShowResolved()),t(h.Actions.logEvent(o))},r.setCommentsEnabled=function(){r.props.dispatch(h.Actions.enableCommenting())},r.setCommentsDisabled=function(){r.props.dispatch(h.Actions.disableCommenting())},r.createComment=function(e){switch(r.props.previewType){case T.PreviewType.Video:case T.PreviewType.Audio:return o.default.createElement(s.TimeCodedComment,n.__assign({},e,{playerIntegrationEnabled:r.props.playerIntegrationEnabled}));case T.PreviewType.Image:case T.PreviewType.SsrDoc:return o.default.createElement(s.NumberedComment,n.__assign({},e));default:return o.default.createElement(s.Comment,n.__assign({},e))}},r.createEditor=function(e){var t=r.props,i=t.currentPageNumber,a=t.pendingNumberedAnnotation,s=t.playerCurrentTime,m=t.playerIntegrationEnabled,c=t.previewType,p=t.showOnboarding,d=o.default.createElement(O,n.__assign({},e,{disabledTimeCodeTooltipComponent:r.createDisabledTimeCodeTooltip,pendingNumberedAnnotation:a,currentPageNumber:i,playerCurrentTime:s,playerIntegrationEnabled:m,previewType:c}));return p?o.default.createElement(S,{markOnboarded:r.markOnboarded,playerIntegrationEnabled:m,previewType:c},d):d},r.createDisabledTimeCodeTooltip=function(e){return o.default.createElement(C.DisabledTimeCodeTooltip,n.__assign({},e,{onClick:r.onTooltipLearnMoreClick,onShow:r.onTooltipLearnMoreView}))},r.onTooltipLearnMoreClick=function(){r.props.dispatch(h.Actions.logEvent("time_based_tooltip_learn_more_click")),A.open_tab("/help/files-folders/comment-timestamp")},r.onTooltipLearnMoreView=function(){return r.props.dispatch(h.Actions.logEvent("time_based_tooltip_learn_more_view"))},r.markOnboarded=function(e){return r.props.dispatch(h.Actions.markOnboarded(e))};var i=t.dispatch,a=t.viewer,m=t.previewType;return r.mentionsApi=v.mentionsApi(a),m!==T.PreviewType.SsrDoc&&m!==T.PreviewType.Image||(r.frameMessageListener=new w.FrameMessageListener(i,m)),r.state={mentionsMatches:r.mentionsApi.cache},r}return n.__extends(t,e),t.prototype.buildResolveOption=function(){var e=this.props.showResolved?_.FileActionButtonType.HIDE_RESOLVED_COMMENTS:_.FileActionButtonType.SHOW_RESOLVED_COMMENTS;return new y.MoreOption({className:"comments-options-item__show-resolved",fileActionButtonType:e,component:function(e){return o.default.createElement("span",null,e.buttonText)},handler:this.toggleShowResolved})},t.prototype.buildEnableOption=function(){var e,t;return this.props.isEnabled?(e=_.FileActionButtonType.DISABLE_COMMENTS,t=this.setCommentsDisabled):(e=_.FileActionButtonType.ENABLE_COMMENTS,t=this.setCommentsEnabled),new y.MoreOption({className:"comments-options-item__disable",fileActionButtonType:e,component:function(e){return o.default.createElement("span",null,e.buttonText)},handler:t})},t.prototype.buildSubscribeOption=function(){var e,t,n=this;return this.props.isSubscribed?(e=_.FileActionButtonType.UNSUBSCRIBE,t=function(){return n.props.dispatch(h.Actions.unsubscribe(void 0))}):(e=_.FileActionButtonType.SUBSCRIBE,t=function(){return n.props.dispatch(h.Actions.subscribe(void 0))}),new y.MoreOption({className:"comments-options-item__subscribe",fileActionButtonType:e,component:function(e){return o.default.createElement("span",null,e.buttonText)},handler:t})},t.prototype.updateCommentsMoreOptionGroup=function(){var e=[];this.props.canEnable&&e.push(this.buildEnableOption()),e.push(this.buildResolveOption()),this.props.canSubscribe&&e.push(this.buildSubscribeOption());var t=new y.MoreOptionGroup({fileActionButtonGroup:_.FileActionButtonGroup.COMMENTS,options:e});void 0===this.moreOptionGroup?f.moreOptionRegistry.addOption(t):f.moreOptionRegistry.replaceOption(this.moreOptionGroup,t),this.moreOptionGroup=t},t.prototype.componentDidMount=function(){this.updateCommentsMoreOptionGroup();var e=this.props,t=e.dispatch,n=e.showOnboarding,o=e.perfEvents,r=+new Date;t(h.Actions.logEvent("show_comments")),t(h.Actions.logPerfEvent("stream_displayed_ms",r-(o.listCompleteTime||0))),t(h.Actions.logPerfEvent("comment_editor_tti_ms",r-(o.setContextTime||0))),n&&t(h.Actions.logEvent("sidebar_onboarding_shown"))},t.prototype.componentDidUpdate=function(e){var t=e.previewType,n=e.requestEditorFocus,o=e.showOnboarding,r=this.props,i=r.showOnboarding,a=r.dispatch,s=r.previewType,m=r.requestEditorFocus;this.updateCommentsMoreOptionGroup(),!o&&i&&a(h.Actions.logEvent("sidebar_onboarding_shown")),!n&&m&&(this.commentStream.focusPrimaryEditor(),a(h.Actions.fulfillEditorFocusRequest())),t!==s&&(null==s?this.frameMessageListener=void 0:s!==T.PreviewType.SsrDoc&&s!==T.PreviewType.Image||(this.frameMessageListener=new w.FrameMessageListener(a,s)))},t.prototype.componentWillUnmount=function(){this.moreOptionGroup&&f.moreOptionRegistry.removeOption(this.moreOptionGroup)},Object.defineProperty(t.prototype,"actionsAdapter",{get:function(){var e=this.props,t=e.dispatch,n=e.onboardingKeysToMark,o=e.pendingNumberedAnnotation,r=e.playerIntegrationEnabled,i=e.previewType,a=e.viewer;return p.createActionsAdapter(t,i,n,this.onMentionsQueryUpdated,r,this.frameMessageListener,a,o)},enumerable:!0,configurable:!0}),t.prototype.render=function(){var e,t=this.props,n=t.showResolved,r=t.isMobile,i=t.stream.id,s=t.viewer,m=t.activeThreadId,p=t.hoverThreadId,l=this.props.threads.filter(function(e){return n||!e.resolved});return s&&(e=g.dbxUserToIUser(s)),o.default.createElement("div",{className:a.default("comments-pane-wrapper",{"no-comment":u.isComments2Mobile()&&0===l.length})},o.default.createElement(c.CommentStream,{ref:this.onCommentStreamRef,id:i,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:!!r,mentionsMatches:this.state.mentionsMatches,settings:{canAnnotate:!0,canComment:!0,canRead:!0},userPermissions:{canAnnotate:!0,canComment:!0,canRead:!0},threads:l,user:e,activeThreadID:m,hoverThreadID:p,showUnreadPill:u.canShowUnreadPill(),localization:E.commentsMasterLocalization}),this.frameMessageListener&&o.default.createElement(d.LegacyAnnotationsBridge,{frameMessageListener:this.frameMessageListener}))},t})(o.default.Component);t.CommentsPaneComponent=P;var I=r.connect(function(e){var t=b.getContext(e),n=t.stream,o=t.viewer;return{activeThreadId:b.getActivatedThreadId(e),hoverThreadId:b.getHoverThreadId(e),playerCurrentTime:b.getPlayerCurrentTime(e),playerIntegrationEnabled:b.getIsPlayerIntegrationEnabled(e),onboardingKeysToMark:b.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:b.getShowOnboardingOnCommentsPane(e),showResolved:b.getShowResolved(e),canEnable:b.getCanEnable(e),isEnabled:b.getIsEnabled(e),canSubscribe:b.getCanSubscribe(e),isSubscribed:b.getIsSubscribed(e),pendingNumberedAnnotation:b.getPendingNumberedAnnotation(e),previewType:b.getPreviewTypeForCurrentFile(e),currentPageNumber:b.getCurrentPageNumber(e),stream:n,threads:b.getThreads(e),viewer:o,perfEvents:b.getData(e).perfEvents,requestEditorFocus:b.getIsEditorFocusRequested(e)}})(P);t.CommentsPane=i.requireCssWithComponent(I,["/static/js/spectrum_comments/index.web-vfl2pTMm8.css","/static/css/comments2-sidebar-vflYPoZcB.css","/static/css/comments_annotations-vflGmnixA.css","/static/css/snackbar-vflLtw9Um.css"])});
//# sourceMappingURL=comments_pane.min.js-vflT7wnlS.map